<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Geolocator + Compass</title>
  <script src="https://code.jquery.com/jquery-1.10.1.min.js"></script>
  <script src="https://maps.google.com/maps/api/js?key=YOUR_API_KEY&sensor=true"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
    }
    .mx-sidebar {
      width: 25%;
      background: #f1f1f1;
      padding: 15px;
      float: left;
    }
    .mx-content {
      margin-left: 25%;
      padding: 15px;
    }
    .scrollmenu {
      overflow: auto;
      white-space: nowrap;
      background: #009688;
      padding: 10px;
    }
    .scrollmenu a {
      color: white;
      padding: 10px;
      text-decoration: none;
    }
    #mapa {
      width: 100%;
      height: 400px;
      margin-top: 20px;
    }
    .compass-container {
      margin: 20px 0;
      text-align: center;
    }
    .compass {
      width: 200px;
      height: 200px;
      margin: 0 auto;
      position: relative;
      background: #fff;
      border-radius: 50%;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
    }
    .compass-arrow {
      position: absolute;
      top: 50%;
      left: 50%;
      width: 20px;
      height: 100px;
      transform-origin: 50% 0;
      transform: translate(-50%, -50%);
      color: red;
      font-size: 24px;
      text-align: center;
    }
    button {
      padding: 10px 20px;
      margin: 5px;
      background: #4CAF50;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    #status {
      margin: 10px 0;
      color: #666;
    }
  </style>
</head>
<body>
  <!-- Sidebar -->
  <div class="mx-sidebar mx-light-grey mx-bar-block">
    <a href="./index.html">Regresar</a>
    <h3 class="mx-bar-item">Herramientas</h3>
  </div>

  <!-- Page Content -->
  <div class="mx-content">
    <div class="mx-teal">
      <h1><a href="./index.html">Geolocator + Compass</a></h1>
    </div>

    <div class="scrollmenu">
      <a href="./factura.html">Facturador</a>
      <a href="#">vacio</a>
      <a href="#">vacio</a>
    </div>

    <div class="mx-container">
      <!-- Compass Section -->
      <div class="compass-container">
        <h2>Brújula</h2>
        <button id="enable-compass">Activar Brújula</button>
        <p id="compass-status">Presiona "Activar Brújula" para comenzar.</p>
        <div class="compass">
          <div class="compass-arrow">↑</div>
        </div>
      </div>

      <!-- Map Section -->
      <h2>Ubicación en tiempo real</h2>
      <article id="mapa"></article>
      <input type="button" id="parar" value="Parar Geolocalización" onclick="detener();"/>
    </div>
  </div>

  <script>
    // --- Geolocation Code (Your Original Code) ---
    var watchId;
    var mapa = null;
    var mapaMarcador = null;	

    if (navigator.geolocation) {
      watchId = navigator.geolocation.watchPosition(mostrarPosicion, mostrarErrores, opciones);	
    } else {
      alert("Tu navegador no soporta la geolocalización, actualiza tu navegador.");
    }

    function mostrarPosicion(posicion) {
      var latitud = posicion.coords.latitude;
      var longitud = posicion.coords.longitude;
      var precision = posicion.coords.accuracy;

      var miPosicion = new google.maps.LatLng(latitud, longitud);

      if (mapa == null) {
        var configuracion = {center: miPosicion, zoom: 16, mapTypeId: google.maps.MapTypeId.HYBRID};
        mapa = new google.maps.Map(document.getElementById("mapa"), configuracion);
        mapaMarcador = new google.maps.Marker({position: miPosicion, title:"Esta es tu posición"});
        mapaMarcador.setMap(mapa);
      } else {
        mapa.panTo(miPosicion);
        mapaMarcador.setPosition(miPosicion);
      }
    }

    function mostrarErrores(error) {
      switch (error.code) {
        case error.PERMISSION_DENIED:
          alert('No podrás ver tu ubicación'); 
          break;
        case error.POSITION_UNAVAILABLE:
          alert('Posición no disponible');
          break; 
        case error.TIMEOUT:
          alert('Tiempo de espera agotado');
          break;
        default:
          alert('Error de Geolocalización desconocido :' + error.code);
      }
    }

    var opciones = {
      enableHighAccuracy: true,
      timeout: 10000,
      maximumAge: 1000
    };

    function detener() {
      navigator.geolocation.clearWatch(watchId);
    }

    // --- Compass Code ---
    const compassArrow = document.querySelector('.compass-arrow');
    const compassStatus = document.getElementById('compass-status');
    const enableCompassBtn = document.getElementById('enable-compass');

    function handleOrientation(event) {
      if (event.alpha === null) {
        compassStatus.textContent = "Mueve tu dispositivo en forma de '8' para calibrar la brújula.";
        return;
      }
      compassArrow.style.transform = `translate(-50%, -50%) rotate(${event.alpha}deg)`;
      compassStatus.textContent = `Dirección: ${Math.round(event.alpha)}°`;
    }

    function enableCompass() {
      if (typeof DeviceOrientationEvent !== 'undefined' && 
          typeof DeviceOrientationEvent.requestPermission === 'function') {
        // iOS 13+ permission flow
        DeviceOrientationEvent.requestPermission()
          .then(response => {
            if (response === 'granted') {
              window.addEventListener('deviceorientation', handleOrientation);
              compassStatus.textContent = "Brújula activada. Gira tu dispositivo.";
              enableCompassBtn.style.display = 'none';
            } else {
              compassStatus.textContent = "Permiso denegado. Recarga y vuelve a intentar.";
            }
          })
          .catch(console.error);
      } else {
        // Non-iOS devices
        if (window.DeviceOrientationEvent) {
          window.addEventListener('deviceorientation', handleOrientation);
          compassStatus.textContent = "Brújula activada. Gira tu dispositivo.";
          enableCompassBtn.style.display = 'none';
        } else {
          compassStatus.textContent = "Tu dispositivo no soporta la brújula.";
        }
      }
    }

    enableCompassBtn.addEventListener('click', enableCompass);
  </script>
</body>
  </html>
